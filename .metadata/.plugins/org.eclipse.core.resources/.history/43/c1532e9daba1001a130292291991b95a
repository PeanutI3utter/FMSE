/*
   Solution for 2.1 b) using end-Labels that mark
   code positions as valid end states.    
 */
mtype = {login, logout} 

inline selectEvent(event) {
  if
   :: event = login
   :: event = logout
  fi   
}

// counts failed authentication tries
byte fail = 0;

// current state
byte currentState = 0;

active proctype Authentication() {
// received event
mtype ev;
do
 :: currentState == 0 ->
           printf("Init");
		   selectEvent(ev);
         //  endBlockInState0a: // allows the if-statement to block, i.e., to hav eno executable alternative
           if
            :: fail >= 3 -> currentState = 2
            :: fail < 3  && ev == login  ->  fail = 0; currentState = 1
            :: fail < 3  && ev == login  ->  fail = fail + 1; currentState = 0 // as we stay in the same state 
                                                                               // the last assignment is not necessary
                                                                               // only to keep the code a bit more 
                                                                               // understandable
           fi
 :: currentState == 1 -> 
           printf("Authenticated"); 
           selectEvent(ev); 
           endBlockInState1: // allows the if-statement to block, i.e., to have no executable alternative
            if
             :: ev == logout -> currentState = 0
            fi 
 :: currentState == 2 -> printf("Locked"); selectEvent(ev)        
od
}
